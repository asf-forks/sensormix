<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:osgi="http://www.springframework.org/schema/osgi"
	xmlns:jaxws="http://cxf.apache.org/jaxws" xmlns:cxf="http://camel.apache.org/schema/cxf"
	xmlns:util="http://www.springframework.org/schema/util" xmlns:context="http://www.springframework.org/schema/context"
	xsi:schemaLocation="
       http://cxf.apache.org/jaxws 
       http://cxf.apache.org/schemas/jaxws.xsd
       http://www.springframework.org/schema/beans 
       http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
       http://www.springframework.org/schema/osgi  
       http://www.springframework.org/schema/osgi/spring-osgi.xsd
       http://camel.apache.org/schema/spring 
       http://camel.apache.org/schema/spring/camel-spring.xsd
       http://camel.apache.org/schema/cxf
	   http://camel.apache.org/schema/cxf/camel-cxf.xsd
	   http://www.springframework.org/schema/util 
	   http://www.springframework.org/schema/util/spring-util-2.5.xsd
	   http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context-2.5.xsd">


	<routeContext id="jsonHttpProcessingRoutes" xmlns="http://camel.apache.org/schema/spring">
		<route id="jsonHttpProcessingRoute">
			<from uri="direct:jsonHttpEntry" />
			<choice>
				<when>
					<simple>${header.CamelHttpMethod} in 'POST,PUT'</simple>
					<to uri="seda:jsonEntry?waitForTaskToComplete=Never" />
					<setHeader headerName="jsonServiceResponse">
						<constant>Samples processed</constant>
					</setHeader>
				</when>
				<otherwise>
					<setHeader headerName="jsonServiceResponse">
						<constant>No body received</constant>
					</setHeader>
				</otherwise>
			</choice>
			<setHeader headerName="Content-Type">
				<constant>application/json</constant>
			</setHeader>
			<to uri="velocity:vm_templates/json_response_template.vm" />
		</route>
	</routeContext>

	<routeContext id="jsonProcessingRoutes" xmlns="http://camel.apache.org/schema/spring">
		<route id="jsonProcessingRoute">
			<from uri="seda:jsonEntry?waitForTaskToComplete=Never" />
			<convertBodyTo type="java.lang.String" />	
<!-- 			<to uri="log:rawJson" /> -->
			<unmarshal>
				<xmljson elementName="item" arrayName="list" rootName="root" />
			</unmarshal>
<!-- 			<to uri="log:rawCdmXml" /> -->
			<to uri="seda:rawXmlEntry" />
		</route>
	</routeContext>

	<!-- TODO: write here XSLT transformation from raw XML to Canonical Data 
		Model Xml -->
	<routeContext id="xmlAdapterRoutes" xmlns="http://camel.apache.org/schema/spring">
		<route id="xmlAdapterRoute">
			<from uri="seda:rawXmlEntry" />
			<to uri="xslt:xslt_adapters/raw2cdm_adapter.xsl" />

			<!-- Debug Log -->
<!-- 			<to uri="log:adaptedCdmXml" /> -->
			<unmarshal>
				<jaxb contextPath="com.google.developers.gdgfirenze.service" />
			</unmarshal>

			<!-- Debug Log -->
<!-- 			<to uri="log:unmarshalledCdmJava" /> -->
			<setHeader headerName="sensormixBodyType">
				<simple>${body.getClass.getName}</simple>
			</setHeader>
			<setHeader headerName="sensormixNumSamples">
				<simple>${body.samples.size}</simple>
			</setHeader>
			<setHeader headerName="sensormixSensor">
				<simple>${body.sensor}</simple>
			</setHeader>

			<!-- Debug Log -->
			<!-- <to uri="log:sendingRecordsToService?showAll=true" /> -->
			<to uri="seda:normalizedJavaSample" />
		</route>
	</routeContext>

</beans>
